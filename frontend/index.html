<!DOCTYPE html>
<html>
<head>
    <title>Geezer Chatbot</title>

    <!-- Prism Theme -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"/>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e1e, #252526);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: #fff;
            position: relative;
            overflow: hidden;
        }
        #welcome-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        text-align: center;
        opacity: 0.8;
        pointer-events: none; /* allows clicks to go through */
    }

    .welcome-content {
        background: none;
        color: #666;
        max-width: 650px;
        font-size: 18px;
    }

        
        
        /* Subtle background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(79, 195, 247, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(0, 120, 212, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        /* Header styling */
        .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: transform 0.3s ease-in-out;
        z-index: 1000;
        }

        .header.hidden {
        transform: translateY(-100%);
}

        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            margin: 8px 0 0 0;
            font-size: 14px;
            color: rgba(255,255,255,0.9);
            font-weight: 400;
        }


        #input-box {
        display: flex;
            align-items: center;
        border-top: 1px solid #444;
            padding: 20px 24px;
            background: linear-gradient(135deg, #252526, #2d2d2d);
            gap: 16px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
        }
        
    textarea {
            flex: 1;
            min-height: 48px;
        max-height: 200px;
        overflow-y: hidden;
        resize: none;
            padding: 14px 16px;
            font-size: 15px;
        line-height: 1.4;
        box-sizing: border-box;
            background: linear-gradient(135deg, #1e1e1e, #252525);
        color: #fff;
            border: 2px solid #555;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        textarea:focus {
            outline: none;
            border-color: #4FC3F7;
            box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.2);
            background: linear-gradient(135deg, #252525, #2d2d2d);
        }
        
        textarea::placeholder {
            color: #888;
            font-style: italic;
        }
        
    button {
            padding: 14px 24px;
            font-size: 15px;
        cursor: pointer;
            background: linear-gradient(135deg, #0078d4, #106ebe);
        color: white;
        border: none;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0, 120, 212, 0.3);
            border: 1px solid #005a9e;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover:not(:disabled) {
            background: linear-gradient(135deg, #106ebe, #005a9e);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 120, 212, 0.4);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 120, 212, 0.3);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            border-color: #555;
        }
        
        /* Loading spinner for button */
        .loading {
            position: relative;
            color: transparent !important;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
    }
        pre {
            border-radius: 8px;
            overflow-x: auto;
            background: #1a1a1a !important;
            border: 1px solid #333;
            margin: 20px 0;
            padding: 25px 20px 20px 20px;
            position: relative;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        pre code {
            background: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
            font-size: 14px;
            line-height: 1.6;
            color: #e6e6e6;
            font-weight: 400;
        }
        
        /* Language indicator */
        pre::before {
            content: attr(data-language);
            display: inline-block;
            background: linear-gradient(135deg, #0078d4, #106ebe);
            color: white;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 6px;
            position: absolute;
            top: -12px;
            left: 20px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            border: 1px solid #005a9e;
        }
        
        /* Code block hover effect */
        pre:hover {
            border-color: #4FC3F7;
            box-shadow: 0 6px 16px rgba(79, 195, 247, 0.2);
            transform: translateY(-1px);
            transition: all 0.3s ease;
        }
        
        /* Inline code improvements */
        .msg.bot code:not(pre code) {
            background: linear-gradient(135deg, #2a2a2a, #333);
            color: #ff6b6b;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            border: 1px solid #444;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .msg.bot code:not(pre code):hover {
            background: linear-gradient(135deg, #333, #444);
            border-color: #ff6b6b;
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        
        /* Better message alignment and spacing */
        .msg.bot {
            margin-bottom: 20px;
            line-height: 1.6;
            background: #2d2d2d;
            border: 1px solid #444;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .msg.bot > div {
            margin-bottom: 15px;
        }
        
        .msg.bot > div:last-child {
            margin-bottom: 0;
        }
        
        /* Explanation section styling */
        .msg.bot .explanation {
            margin-bottom: 20px;
            line-height: 1.7;
            padding: 15px;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            border-left: 3px solid #4FC3F7;
        }
        
        .msg.bot .explanation p {
            margin: 0 0 12px 0;
            color: #e6e6e6;
        }
        
        .msg.bot .explanation p:last-child {
            margin-bottom: 0;
        }
        
        .msg.bot .explanation h1,
        .msg.bot .explanation h2,
        .msg.bot .explanation h3,
        .msg.bot .explanation h4 {
            margin: 20px 0 10px 0;
            color: #4FC3F7;
            font-weight: 600;
        }
        
        .msg.bot .explanation h1 {
            font-size: 24px;
            border-bottom: 2px solid #4FC3F7;
            padding-bottom: 8px;
        }
        
        .msg.bot .explanation h2 {
            font-size: 20px;
            border-bottom: 1px solid #4FC3F7;
            padding-bottom: 6px;
        }
        
        .msg.bot .explanation h3 {
            font-size: 18px;
        }
        
        .msg.bot .explanation h4 {
            font-size: 16px;
        }
        
        .msg.bot .explanation ul {
            margin: 10px 0 10px 20px;
            padding-left: 0;
        }
        
        .msg.bot .explanation li {
            margin-bottom: 8px;
            color: #e6e6e6;
        }
        
        .msg.bot .explanation strong {
            color: #FFD700;
            font-weight: 600;
        }
        
        .msg.bot .explanation em {
            color: #FFB6C1;
            font-style: italic;
        }
        
        .msg.bot .explanation blockquote {
            margin: 15px 0;
            padding: 10px 15px;
            background: rgba(79, 195, 247, 0.1);
            border-left: 4px solid #4FC3F7;
            border-radius: 4px;
            font-style: italic;
            color: #b0b0b0;
        }
        
        .msg.bot .explanation a {
            color: #4FC3F7;
            text-decoration: none;
            border-bottom: 1px dotted #4FC3F7;
        }
        
        .msg.bot .explanation a:hover {
            color: #81D4FA;
            border-bottom: 1px solid #81D4FA;
        }
        
        /* Copy button styling */
        .copy-code-btn {
            margin-top: 20px;
            padding: 12px 20px;
            font-size: 14px;
            background: linear-gradient(135deg, #0078d4, #106ebe);
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0, 120, 212, 0.3);
            border: 1px solid #005a9e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .copy-code-btn:hover {
            background: linear-gradient(135deg, #106ebe, #005a9e);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 120, 212, 0.4);
        }
        
        .copy-code-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 120, 212, 0.3);
        }
        
        .copy-code-btn.copied {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border-color: #45a049;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        
        /* Streaming indicator */
        .streaming-indicator {
            color: #4FC3F7;
            font-style: italic;
            animation: pulse 2s infinite;
            margin-bottom: 15px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(79, 195, 247, 0.1), rgba(79, 195, 247, 0.05));
            border-radius: 8px;
            border-left: 4px solid #4FC3F7;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(79, 195, 247, 0.2);
        }
        
        .content {
            margin-top: 15px;
            line-height: 1.6;
        }
        
        .completion-indicator {
            margin-top: 20px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05));
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            color: #4CAF50;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
            text-align: center;
        }
        
        /* Enhanced pulse animation */
        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.8; 
                transform: scale(1.02);
            }
        }
        
        /* Typing indicator styles */
        .typing {
            background: #2d2d2d !important;
        }
        
        .typing-dots {
            display: inline-block;
        }
        
        .dot {
            animation: typing 1.4s infinite;
            opacity: 0;
        }
        
        .dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0;
            }
            30% {
                opacity: 1;
            }
        }
        
        /* Enhanced message styling */
        .msg {
            margin-bottom: 16px;
            max-width: 80%;
            padding: 16px;
            border-radius: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
            animation: fadeInUp 0.3s ease-out;
            transition: all 0.3s ease;
        }
        
        .msg:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        }
        
        .user {
            background: linear-gradient(135deg, #0078d4, #106ebe);
            color: white;
            margin-left: auto;
            box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
            border: 1px solid #005a9e;
        }
        
        .user:hover {
            box-shadow: 0 6px 20px rgba(0, 120, 212, 0.4);
        }
        
        .bot {
            background: linear-gradient(135deg, #2d2d2d, #252525);
            color: white;
            margin-right: auto;
            border: 1px solid #444;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        .bot:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.6);
            border-color: #555;
        }
        
        /* Fade in animation for messages */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Improved chat container */
        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: linear-gradient(135deg, #1e1e1e, #252526);
        }
        
        /* Custom scrollbar */
        #chat::-webkit-scrollbar {
            width: 8px;
        }
        
        #chat::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 4px;
        }
        
        #chat::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #0078d4, #106ebe);
            border-radius: 4px;
        }
        
        #chat::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #106ebe, #005a9e);
        }
        
        /* Responsive design for mobile devices */
        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .header p {
                font-size: 13px;
            }
            
            #chat {
                padding: 16px;
            }
            
            .msg {
                max-width: 90%;
                padding: 12px;
                margin-bottom: 12px;
            }
            
            #input-box {
                padding: 16px 20px;
                gap: 12px;
            }
            
            textarea {
                min-height: 44px;
                padding: 12px 14px;
                font-size: 14px;
            }
            
            button {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            pre {
                margin: 16px 0;
                padding: 20px 16px 16px 16px;
            }
            
            pre::before {
                font-size: 11px;
                padding: 6px 12px;
                top: -10px;
                left: 16px;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 12px 16px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .header p {
                font-size: 12px;
            }
            
            #chat {
                padding: 12px;
            }
            
            .msg {
                max-width: 95%;
                padding: 10px;
                margin-bottom: 10px;
            }
            
            #input-box {
                padding: 12px 16px;
                gap: 10px;
            }
            
            textarea {
                min-height: 40px;
                padding: 10px 12px;
                font-size: 13px;
            }
            
            button {
                padding: 10px 16px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚀 CodeBot.ai</h1>
        <p>Your intelligent coding assistant powered by Ollama</p>
    </div>
    
    <div id="chat"></div>

    <div id="input-box">
        <textarea id="prompt" rows="2" placeholder="Ask me to write code..."></textarea>
        <button onclick="sendMessage()">Send</button>
    </div>

    <!-- Prism.js - Single Bundle for Better Performance -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>

    <!-- Markdown Parser (Fixes "marked is not defined") -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
    const chatBox = document.getElementById('chat');
    const sendBtn = document.querySelector("button");
    let isProcessing = false;

    // Get the textarea element by its ID
const textarea = document.getElementById("prompt");

// Add the 'input' event listener
textarea.addEventListener("input", function () {
  this.style.height = "auto"; // Reset height to recalculate
  const newHeight = this.scrollHeight;
  const maxHeight = 200; // Define your maximum height here

  if (newHeight <= maxHeight) {
    this.style.overflowY = "hidden"; // Hide scrollbar
    this.style.height = newHeight + "px"; // Expand height
  } else {
    this.style.overflowY = "auto"; // Show scrollbar
    this.style.height = maxHeight + "px"; // Lock height
  }
});

// Create typing indicator
function createTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.classList.add('msg', 'bot', 'typing');
    typingDiv.innerHTML = `
        <div class="typing-dots">
            <span class="dot">.</span>
            <span class="dot">.</span>
            <span class="dot">.</span>
        </div>
    `;
    return typingDiv;
}

// Remove typing indicator
function removeTypingIndicator() {
    const typingIndicator = document.querySelector('.typing');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Append message to chat
function appendMessage(sender, text) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('msg', sender);
    msgDiv.textContent = text;
    chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

// Split explanation and code from response
    function splitExplanationAndCode(text) {
    // Look for code blocks marked with ``` or ```
    const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
    const codeBlocks = [];
    let match;
    
    while ((match = codeBlockRegex.exec(text)) !== null) {
        const lang = match[1] || 'plaintext';
        const code = match[2].trim();
        codeBlocks.push({ lang, code });
    }
    
    if (codeBlocks.length > 0) {
        // Remove code blocks from text to get explanation
        let explanation = text.replace(codeBlockRegex, '').trim();
        
        // If multiple code blocks, combine them
        if (codeBlocks.length === 1) {
            return {
                explanation: explanation || null,
                code: codeBlocks[0].code,
                lang: codeBlocks[0].lang
            };
        } else {
            // Multiple code blocks - combine them
            const combinedCode = codeBlocks.map(block => 
                `\n// ${block.lang.toUpperCase()}\n${block.code}`
            ).join('\n\n');
            return {
                explanation: explanation || null,
                code: combinedCode,
                lang: 'mixed'
            };
        }
    }
    
    // No code blocks found
    return {
        explanation: text,
        code: null,
        lang: null
    };
}

// Format explanation text with markdown
function formatExplanation(text) {
    if (!text) return '';
    
    // Convert markdown to HTML
    const html = marked.parse(text);
    
    // Apply some basic styling
    return html
        .replace(/<h1>/g, '<h1 style="color: #4FC3F7; margin: 20px 0 15px 0; font-size: 24px;">')
        .replace(/<h2>/g, '<h2 style="color: #4FC3F7; margin: 18px 0 12px 0; font-size: 20px;">')
        .replace(/<h3>/g, '<h3 style="color: #4FC3F7; margin: 16px 0 10px 0; font-size: 18px;">')
        .replace(/<h4>/g, '<h4 style="color: #4FC3F7; margin: 14px 0 8px 0; font-size: 16px;">')
        .replace(/<p>/g, '<p style="margin: 0 0 12px 0; line-height: 1.6;">')
        .replace(/<ul>/g, '<ul style="margin: 10px 0 10px 20px; padding-left: 0;">')
        .replace(/<li>/g, '<li style="margin-bottom: 8px;">')
        .replace(/<strong>/g, '<strong style="color: #FFD700;">')
        .replace(/<em>/g, '<em style="color: #FFB6C1;">');
    }

async function sendMessage() {
    if (isProcessing) return;
    const promptEl = document.getElementById('prompt');
    const text = promptEl.value.trim();
    if (!text) return;
    promptEl.value = "";

    isProcessing = true;
    sendBtn.disabled = true;
    sendBtn.textContent = "Thinking...";
    sendBtn.classList.add('loading');

    appendMessage("user", text);
    
    // Show typing indicator
    const typingIndicator = createTypingIndicator();
    chatBox.appendChild(typingIndicator);
    chatBox.scrollTop = chatBox.scrollHeight;

    try {
        // Add timeout to the fetch request
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minutes timeout
        
        const res = await fetch(`http://127.0.0.1:8000/generate?prompt=${encodeURIComponent(text)}`, {
            method: "POST",
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);

        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }

        // Remove typing indicator
        removeTypingIndicator();

        // Create bot message container
        const botDiv = document.createElement('div');
        botDiv.classList.add('msg', 'bot');
        botDiv.innerHTML = '<div class="streaming-indicator">🔄 Starting response...</div>';
        chatBox.appendChild(botDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let fullText = "";
        let totalChunks = 0;
        const streamStartTime = Date.now(); // Start time for streaming metrics

        // REAL-TIME STREAMING - Display each chunk immediately!
        while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    const chunk = decoder.decode(value, { stream: true });

    // ✅ detect explicit end marker from backend
    if (chunk.includes("[STREAM_DONE]")) {
        console.log("✅ Stream completed");
        break;
    }

    fullText += chunk;
    totalChunks++;

    // show partial response in real-time
    botDiv.innerHTML = `
        <div class="streaming-indicator">
            🔄 Receiving response... (${totalChunks} chunks, ${fullText.length} chars)
        </div>
        <div class="content">${fullText.replace(/\n/g, '<br>')}</div>
    `;
    chatBox.scrollTop = chatBox.scrollHeight;

    await new Promise(resolve => setTimeout(resolve, 10));
}

        
        // Final display update with proper formatting
        const { explanation, code, lang } = splitExplanationAndCode(fullText);
        
        // Debug logging
        console.log('🔍 Code detection:', { explanation: !!explanation, code: !!code, lang, langType: typeof lang });
        
        if (code) {
            // Ensure lang is a valid string and sanitize it
            const safeLang = (lang && typeof lang === 'string') ? lang.replace(/[^a-zA-Z0-9]/g, '') : 'plaintext';
            console.log('🔍 Language processing:', { original: lang, sanitized: safeLang });
            
            botDiv.innerHTML = `
                ${explanation ? `<div class="explanation">${formatExplanation(explanation)}</div>` : ''}
                <pre data-language="${safeLang}"><code class="language-${safeLang}">${code}</code></pre>
            `;
            
            // Apply syntax highlighting specifically to this code block
            const codeElement = botDiv.querySelector('code');
            if (codeElement) {
                // Apply highlighting immediately without delays
                if (typeof Prism !== 'undefined') {
                    try {
                        Prism.highlightElement(codeElement);
                        console.log('✅ Syntax highlighting applied to:', safeLang);
                    } catch (error) {
                        console.warn('❌ Syntax highlighting failed:', error);
                    }
                } else {
                    console.warn('❌ Prism.js not available for highlighting');
                }
            }
            
            // Also highlight any inline code in the explanation immediately
            const inlineCodeElements = botDiv.querySelectorAll('code:not(pre code)');
            inlineCodeElements.forEach(element => {
                if (element.textContent && element.textContent.length > 0) {
                    if (typeof Prism !== 'undefined') {
                        try {
                            Prism.highlightElement(element);
                        } catch (error) {
                            console.warn('Inline code highlighting failed:', error);
                        }
                    }
                }
            });
        } else {
            botDiv.innerHTML = formatExplanation(fullText);
        }

        // Add copy button if there's code
        if (code) {
            const copyBtn = document.createElement("button");
            copyBtn.textContent = "Copy Code";
            copyBtn.className = "copy-code-btn";
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(code)
                    .then(() => {
                        copyBtn.textContent = "Copied!";
                        copyBtn.classList.add("copied");
                    })
                    .catch(() => alert("Copy failed"));
                setTimeout(() => {
                    copyBtn.textContent = "Copy Code";
                    copyBtn.classList.remove("copied");
                }, 2000);
            };

            botDiv.appendChild(copyBtn);
        }
        
        // Add performance metrics to the response
        const endTime = Date.now();
        const totalTime = endTime - streamStartTime;
        const charsPerSecond = Math.round(fullText.length / (totalTime / 1000));
        
        console.log(`🚀 Response completed in ${totalTime}ms, ${fullText.length} chars, ${charsPerSecond} chars/sec`);
        
        // Show completion message
        const completionDiv = document.createElement('div');
        completionDiv.className = 'completion-indicator';
        completionDiv.innerHTML = `✅ Response completed in ${totalTime}ms (${charsPerSecond} chars/sec)`;
        botDiv.appendChild(completionDiv);
        
    } catch (err) {
        removeTypingIndicator();
        let errorMessage = "❌ Error: ";
        
        if (err.name === 'AbortError') {
            errorMessage += "Request timed out. Please try again.";
        } else if (err.message.includes('Failed to fetch')) {
            errorMessage += "Cannot connect to backend. Please check if the server is running.";
        } else {
            errorMessage += err.message;
        }
        
        appendMessage("bot", errorMessage);
        console.error("Error:", err);
    } finally {
    isProcessing = false;
    sendBtn.disabled = false;
    sendBtn.textContent = "Send";
        sendBtn.classList.remove('loading');
    }
}
let lastScrollTop = 0;
window.addEventListener("scroll", function() {
  const header = document.querySelector(".header");
  let currentScroll = window.pageYOffset || document.documentElement.scrollTop;

  if (currentScroll > lastScrollTop) {
    // scrolling down → hide
    header.classList.add("hidden");
  } else {
    // scrolling up → show
    header.classList.remove("hidden");
  }

  lastScrollTop = currentScroll <= 0 ? 0 : currentScroll; // avoid negative
}, false);


// Handle Enter key in textarea
textarea.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Test backend connection
async function testConnection() {
    try {
        const res = await fetch('http://127.0.0.1:8000/health', {
            method: 'GET',
            signal: AbortSignal.timeout(5000) // 5 second timeout
        });
        
        if (res.ok) {
            console.log('✅ Backend connection successful');
            return true;
        } else {
            console.log('❌ Backend responded with error:', res.status);
            return false;
        }
    } catch (err) {
        console.log('❌ Backend connection failed:', err.message);
        return false;
    }
}

// Test connection when page loads
window.addEventListener('load', () => {
    testConnection();
    
    // Check if Prism.js is properly loaded
    if (typeof Prism === 'undefined') {
        console.warn('Prism.js not loaded, syntax highlighting will be disabled');
    } else {
        console.log('✅ Prism.js loaded successfully');
    }

    // Add welcome background message
    const welcomeDiv = document.createElement('div');
    welcomeDiv.id = "welcome-overlay";
    welcomeDiv.innerHTML = `
        <div class="welcome-content">
            <h3>🚀 Welcome to CodeBot AI!</h3>
            <p>I'm your intelligent coding assistant powered by Ollama. I can help you with:</p>
            <ul>
                <li><strong>Code Generation</strong> - Write code in any programming language</li>
                <li><strong>Code Explanation</strong> - Understand complex code snippets <em>(in development)</em></li>
                <li><strong>Debugging Help</strong> - Fix issues in your code <em>(in development)</em></li>
                <li><strong>Best Practices</strong> - Learn coding standards and patterns <em>(in development)</em></li>
            </ul>
            <p>Just ask me to write code, explain something, or help you solve a programming problem!</p>
        </div>
    `;
    chatBox.appendChild(welcomeDiv);

    // Disappear after first query
    const inputField = document.getElementById("user-input"); // adjust to your input field id
    const sendBtn = document.getElementById("send-btn"); // adjust to your send button id

    function removeWelcome() {
        const overlay = document.getElementById("welcome-overlay");
        if (overlay) overlay.remove();
        inputField.removeEventListener("keydown", checkEnter);
        sendBtn.removeEventListener("click", removeWelcome);
    }

    function checkEnter(e) {
        if (e.key === "Enter" && inputField.value.trim() !== "") {
            removeWelcome();
        }
    }

    inputField.addEventListener("keydown", checkEnter);
    sendBtn.addEventListener("click", removeWelcome);
});


// Safe Prism highlighting function
function safeHighlight(element) {
    if (typeof Prism !== 'undefined' && element) {
        try {
            Prism.highlightElement(element);
            return true;
        } catch (error) {
            console.warn('Prism highlighting failed:', error);
            return false;
        }
    }
    return false;
}
    </script>
</body>
</html>
